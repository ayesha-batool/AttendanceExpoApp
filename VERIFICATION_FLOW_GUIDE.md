# 🔐 Email Verification Flow Guide

## 📋 **Overview**

This guide explains how the email verification system works in the app, including where the `userId` and `secret` parameters come from and how the verification page is triggered.

## 🔄 **Complete Verification Flow**

### **Step 1: User Registration**
1. User fills out registration form (email, password, name)
2. App creates account via `authService.register()`
3. User is automatically logged in after registration
4. App shows success message and prompts user to check email

### **Step 2: Verification Email Sent**
1. App calls `sendVerificationEmail()` from `AuthContext`
2. This calls `appwriteEmailVerification.sendVerificationEmail()`
3. Appwrite sends verification email with a link like:
   ```
   https://cloud.appwrite.io/v1/account/verification?userId=64f8a1b2c3d4e5f6&secret=abc123def456&url=shelfieclean://verify
   ```

### **Step 3: User Clicks Email Link**
1. User receives email and clicks the verification link
2. Appwrite redirects to: `shelfieclean://verify?userId=64f8a1b2c3d4e5f6&secret=abc123def456`
3. This triggers the app's deep linking system

### **Step 4: Deep Link Handling**
1. App's `_layout.jsx` detects the deep link
2. Extracts `userId` and `secret` from URL parameters
3. Navigates to `/verify` page with parameters

### **Step 5: Verification Page Processing**
1. `app/verify.jsx` receives the parameters
2. Calls `completeVerification(userId, secret)` from `AuthContext`
3. This calls `appwriteEmailVerification.completeVerification()`
4. Appwrite verifies the account
5. User is redirected to dashboard

## 🔍 **Where userId and secret Come From**

### **userId**
- **Source**: Generated by Appwrite when user account is created
- **Format**: 24-character alphanumeric string (e.g., `64f8a1b2c3d4e5f6`)
- **Purpose**: Identifies which user account to verify

### **secret**
- **Source**: Generated by Appwrite when verification email is sent
- **Format**: Random string (e.g., `abc123def456`)
- **Purpose**: Security token to prevent unauthorized verification
- **Expiration**: Typically expires after 24 hours

## 🛠 **Technical Implementation**

### **Deep Linking Setup**
```javascript
// app/_layout.jsx
useEffect(() => {
  const handleDeepLink = (event) => {
    const url = event.url;
    if (url.includes('shelfieclean://verify')) {
      const urlObj = new URL(url);
      const userId = urlObj.searchParams.get('userId');
      const secret = urlObj.searchParams.get('secret');
      
      if (userId && secret) {
        router.push(`/verify?userId=${userId}&secret=${secret}`);
      }
    }
  };
  
  // Listen for deep link events
  const subscription = Linking.addEventListener('url', handleDeepLink);
  return () => subscription?.remove();
}, [router]);
```

### **Verification URL Configuration**
```javascript
// services/appwriteEmailVerification.js
const response = await accountService.createVerification(
  process.env.EXPO_PUBLIC_VERIFICATION_URL || 'shelfieclean://verify'
);
```

### **App Configuration**
```json
// app.json
{
  "expo": {
    "scheme": "shelfieclean",
    // ... other config
  }
}
```

## 🧪 **Testing the Verification Flow**

### **Method 1: Real Email Testing**
1. Register a new user with real Gmail address
2. Check email for verification link
3. Click the link to test deep linking
4. Verify the app opens and processes verification

### **Method 2: Using Test Tools**
1. Navigate to `/test-verification` in the app
2. Use "Test Complete Flow" button
3. This will send a real verification email
4. Click the email link to test the flow

### **Method 3: Manual Deep Link Testing**
1. Use "Test Deep Link" button in test page
2. This simulates the deep link parsing
3. Check console logs for parameter extraction

## 🔧 **Debugging Tools**

### **Available Test Functions**
- **Test Configuration**: Verify environment variables
- **Debug Authentication**: Check current user status
- **Test Verification**: Test verification system
- **Test Deep Link**: Test deep link parsing
- **Test Complete Flow**: End-to-end verification test

### **Console Logs to Watch**
```
🔗 Deep link received: shelfieclean://verify?userId=...&secret=...
📧 Verification deep link detected
🆔 userId: 64f8a1b2c3d4e5f6
🔑 secret: abc123def456
✅ Valid verification parameters, navigating to verify page
```

## 🚨 **Common Issues and Solutions**

### **Issue: VerifyPage not called**
**Solution**: Ensure `/verify` screen is registered in Stack
```javascript
<Stack.Screen name="verify" />
```

### **Issue: Missing userId/secret**
**Solution**: Check deep link handling in `_layout.jsx`

### **Issue: Deep link not working**
**Solution**: Verify app scheme in `app.json` and deep link setup

### **Issue: Verification fails**
**Solution**: Check Appwrite configuration and user authentication status

## 📱 **Environment Variables Required**

```bash
EXPO_PUBLIC_APPWRITE_ENDPOINT=https://cloud.appwrite.io/v1
EXPO_PUBLIC_APPWRITE_PROJECT_ID=your_project_id
EXPO_PUBLIC_VERIFICATION_URL=shelfieclean://verify
```

## 🎯 **Summary**

The verification flow works as follows:
1. **Registration** → Creates account and sends verification email
2. **Email Link** → Contains `userId` and `secret` parameters
3. **Deep Link** → App detects and parses the URL
4. **Verify Page** → Processes verification with extracted parameters
5. **Success** → User account is verified and can access full features

The `userId` and `secret` are automatically generated by Appwrite and included in the verification email link. The app's deep linking system extracts these parameters and passes them to the verification page for processing.
